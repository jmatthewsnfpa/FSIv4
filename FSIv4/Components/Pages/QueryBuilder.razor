@page "/query-builder"
@using FSIv4.Data.Models
@using FSIv4.Data.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@inject IQueryBuilderService QueryService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin, Owner, Reader")]

<PageTitle>Query Builder</PageTitle>

<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header" style="background-color: #2a6b6b; color: white;">
            <h3 class="mb-0">
                <i class="fas fa-search me-2"></i>Query Builder
            </h3>
        </div>

        <div class="card-body">
            <!-- Table Selection -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">1. Select Data Set</h5>
                        </div>
                        <div class="card-body">
                            <select class="form-select"
                                    value="@Model.TableName"
                                    @onchange="@((ChangeEventArgs e) => OnTableChanged(e))">
                                <option value="FSI">Fire Department Data (FSI)</option>
                                <option value="ProtectedTowns">Protected Towns</option>
                            </select>
                            <small class="text-muted mt-2">
                                Total records: @totalRecords.ToString("N0")
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Column Selection</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox"
                                       checked="@Model.IncludeAllColumns"
                                       @onchange="@((ChangeEventArgs e) => OnIncludeAllColumnsChanged(e))" />
                                <label class="form-check-label fw-bold">
                                    Include All Columns
                                </label>
                            </div>

                            @if (!Model.IncludeAllColumns)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           checked="@selectAllColumns"
                                           @onchange="@((ChangeEventArgs e) => OnSelectAllColumnsChanged(e))" />
                                    <label class="form-check-label">
                                        Select All Columns
                                    </label>
                                </div>

                                <div class="mt-3" style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var column in availableColumns)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   checked="@IsColumnSelected(column.Name)"
                                                   @onchange="@((ChangeEventArgs e) => OnColumnChanged(e, column.Name))" />
                                            <label class="form-check-label small">
                                                @column.DisplayName
                                            </label>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">2. Add Filters (Optional)</h5>
                            <div>
                                <button class="btn btn-sm btn-primary" @onclick="AddCondition">
                                    <i class="fas fa-plus me-1"></i> Add Filter
                                </button>
                                <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="ClearAllConditions">
                                    <i class="fas fa-ban me-1"></i> Clear All
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (Model.Conditions.Any())
                            {
                                <div class="filter-group">
                                    @foreach (var condition in Model.Conditions)
                                    {
                                        <div class="filter-row mb-3 p-3 border rounded">
                                            <div class="row g-2 align-items-end">
                                                <div class="col-md-3">
                                                    <label class="form-label small mb-1">Field</label>
                                                    <select class="form-select"
                                                            value="@condition.Column"
                                                            @onchange="@((ChangeEventArgs e) => OnConditionColumnChanged(e, condition))">
                                                        <option value="">Select a field...</option>
                                                        @foreach (var col in availableColumns)
                                                        {
                                                            <option value="@col.Name">@col.DisplayName</option>
                                                        }
                                                    </select>
                                                </div>

                                                <div class="col-md-2">
                                                    <label class="form-label small mb-1">Operator</label>
                                                    <select class="form-select" @bind="condition.Operator">
                                                        @if (GetColumn(condition.Column) != null)
                                                        {
                                                            @foreach (var op in GetColumn(condition.Column).Operators)
                                                            {
                                                                <option value="@op">@op</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>

                                                <div class="col-md-5">
                                                    <label class="form-label small mb-1">Value</label>
                                                    @if (GetColumn(condition.Column) != null)
                                                    {
                                                        var col = GetColumn(condition.Column);

                                                        @if (col.IsEnum)
                                                        {
                                                            <select class="form-select" @bind="condition.Value">
                                                                <option value="">Select...</option>
                                                                @foreach (var enumValue in GetEnumOptions(col.Name))
                                                                {
                                                                    <option value="@enumValue">@enumValue</option>
                                                                }
                                                            </select>
                                                        }
                                                        else if (condition.Operator == "BETWEEN")
                                                        {
                                                            <div class="input-group">
                                                                <input type="text" class="form-control"
                                                                       @bind="condition.Value"
                                                                       placeholder="From..." />
                                                                <span class="input-group-text">to</span>
                                                                <input type="text" class="form-control"
                                                                       @bind="condition.SecondValue"
                                                                       placeholder="To..." />
                                                            </div>
                                                        }
                                                        else if (col.DataType == "datetime")
                                                        {
                                                            <input type="date" class="form-control"
                                                                   value="@(condition.DateValue?.ToString("yyyy-MM-dd") ?? "")"
                                                                   @onchange="@((ChangeEventArgs e) => OnDateValueChanged(e, condition))" />
                                                        }
                                                        else if (col.DataType == "int")
                                                        {
                                                            <input type="number" class="form-control"
                                                                   value="@condition.IntValue"
                                                                   @onchange="@((ChangeEventArgs e) => OnIntValueChanged(e, condition))" />
                                                        }
                                                        else
                                                        {
                                                            <input type="text" class="form-control"
                                                                   @bind="condition.Value"
                                                                   placeholder="Enter value..." />
                                                        }
                                                    }
                                                </div>

                                                <div class="col-md-2">
                                                    <button class="btn btn-danger btn-sm w-100"
                                                            @onclick="@(() => RemoveCondition(condition.Id))">
                                                        <i class="fas fa-trash"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="fas fa-filter fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">No filters added. Add filters to narrow your results.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sorting -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">3. Sorting</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Sort By</label>
                                    <select class="form-select" @bind="Model.SortColumn">
                                        <option value="">No sorting</option>
                                        @foreach (var col in availableColumns)
                                        {
                                            <option value="@col.Name">@col.DisplayName</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Order</label>
                                    <select class="form-select" @bind="Model.SortDescending">
                                        <option value="false">Ascending (A-Z)</option>
                                        <option value="true">Descending (Z-A)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @* Row Limit Selector. For now will hard code it in the query builder service
                    
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">4. Row Limit</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Maximum Rows</label>
                                <input type="number" class="form-control" 
                                       @bind="Model.RowLimit" min="1" max="1000000" />
                                <small class="form-text text-muted">
                                    For exports, maximum 1,000,000 rows
                                </small>
                            </div>
                        </div>
                    </div>
                </div>*@
            </div>

            <!-- Action Buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button class="btn btn-primary me-2" @onclick="PreviewData"
                                            disabled="@isLoading">
                                        <i class="fas fa-eye me-1"></i> Preview Results
                                        @if (isLoading)
                                        {
                                            <span class="spinner-border spinner-border-sm ms-1"></span>
                                        }
                                    </button>

                                    <button class="btn btn-warning me-2" @onclick="DownloadResults"
                                            disabled="@(isLoading || previewResult == null)">
                                        <i class="fas fa-download me-1"></i> Download CSV
                                    </button>
                                </div>

                                <button class="btn btn-danger" @onclick="ResetBuilder">
                                    <i class="fas fa-redo me-1"></i> Reset All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Results -->
            @if (previewResult != null)
            {
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>
                                    Preview Results
                                </h5>
                                <span class="badge bg-light text-dark">
                                    Showing @previewResult.PreviewCount of @previewResult.TotalCount.ToString("N0") records
                                </span>
                            </div>

                            <div class="card-body">
                                @if (previewResult.Data.Any())
                                {
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Preview limited to @previewResult.PreviewCount rows.
                                        Download the full dataset to see all @previewResult.TotalCount.ToString("N0") records.
                                    </div>

                                    <div class="table-responsive" style="max-height: 500px;">
                                        <table class="table table-sm table-striped table-hover">
                                            <thead class="sticky-top bg-white">
                                                <tr>
                                                    @foreach (var column in previewResult.Columns.Take(8))
                                                    {
                                                        <th>@column</th>
                                                    }
                                                    @if (previewResult.Columns.Count > 8)
                                                    {
                                                        <th>...</th>
                                                    }
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in previewResult.Data)
                                                {
                                                    <tr>
                                                        @foreach (var column in previewResult.Columns.Take(8))
                                                        {
                                                            <td class="small">@row[column]?.ToString()</td>
                                                        }
                                                        @if (previewResult.Columns.Count > 8)
                                                        {
                                                            <td class="text-muted small">...</td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center py-5">
                                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No records match your criteria</h5>
                                        <p class="text-muted">Try adjusting your filters or remove them to see all records.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Download Progress Modal -->
            @if (showDownloadProgress)
            {
                <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Preparing Download</h5>
                            </div>
                            <div class="modal-body">
                                <div class="text-center">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Generating CSV file with @previewResult?.TotalCount.ToString("N0") records...</p>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                             style="width: 100%"></div>
                                    </div>
                                    <p class="small text-muted mt-2">
                                        File size will be approximately @(previewResult?.TotalCount * 500 / 1024 / 1024) MB
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private QueryBuilderModel Model = new();
    private List<ColumnDefinition> availableColumns = new();
    private PreviewResult previewResult;
    private bool isLoading = false;
    private bool showDownloadProgress = false;
    private bool selectAllColumns = false;
    private int totalRecords = 0;

    private Dictionary<string, List<string>> enumOptions = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTableData();
        enumOptions = QueryService.GetEnumOptions();
    }

    private async Task LoadTableData()
    {
        availableColumns = QueryService.GetAvailableColumns(Model.TableName);
        totalRecords = await QueryService.GetTotalRecordsCountAsync(Model.TableName);

        // Reset selected columns when table changes
        Model.SelectedColumns.Clear();
        selectAllColumns = false;
        previewResult = null;
        StateHasChanged();
    }

    private async void OnTableChanged(ChangeEventArgs e)
    {
        Model.TableName = e.Value?.ToString() ?? "FSI";
        await LoadTableData();
    }

    private async void OnIncludeAllColumnsChanged(ChangeEventArgs e)
    {
        Model.IncludeAllColumns = (bool)(e.Value ?? false);
        if (Model.IncludeAllColumns)
        {
            Model.SelectedColumns.Clear();
            selectAllColumns = false;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async void OnSelectAllColumnsChanged(ChangeEventArgs e)
    {
        selectAllColumns = (bool)(e.Value ?? false);
        if (selectAllColumns)
        {
            Model.SelectedColumns = availableColumns.Select(c => c.Name).ToList();
        }
        else
        {
            Model.SelectedColumns.Clear();
        }
        await InvokeAsync(StateHasChanged);
    }

    private async void OnColumnChanged(ChangeEventArgs e, string columnName)
    {
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked && !Model.SelectedColumns.Contains(columnName))
        {
            Model.SelectedColumns.Add(columnName);
        }
        else if (!isChecked)
        {
            Model.SelectedColumns.Remove(columnName);
        }

        // Update selectAllColumns based on current selection
        selectAllColumns = Model.SelectedColumns.Count == availableColumns.Count;
        await InvokeAsync(StateHasChanged);
    }

    private async void OnConditionColumnChanged(ChangeEventArgs e, FilterCondition condition)
    {
        condition.Column = e.Value?.ToString();

        // Set default operator for the selected column
        var column = GetColumn(condition.Column);
        if (column != null && column.Operators.Any())
        {
            condition.Operator = column.Operators.First();
            condition.Value = ""; // Clear previous value
            condition.SecondValue = "";
        }

        await InvokeAsync(StateHasChanged);
    }

    //For user to set row limit if needed in future
    // private async void OnRowLimitChanged(ChangeEventArgs e)
    // {
    //     if (int.TryParse(e.Value?.ToString(), out int limit) && limit > 0)
    //     {
    //         Model.RowLimit = limit;
    //     }
    //     await InvokeAsync(StateHasChanged);
    // }

    private void AddCondition()
    {
        Model.Conditions.Add(new FilterCondition());
    }

    private void RemoveCondition(string id)
    {
        Model.Conditions.RemoveAll(c => c.Id == id);
    }

    private void ClearAllConditions()
    {
        Model.Conditions.Clear();
    }

    private async Task PreviewData()
    {
        isLoading = true;
        try
        {
            previewResult = await QueryService.GetPreviewDataAsync(Model);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DownloadResults()
    {
        if (previewResult == null || previewResult.TotalCount == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "No data to download. Please preview results first.");
            return;
        }

        showDownloadProgress = true;
        StateHasChanged();

        try
        {
            var stream = await QueryService.GenerateCsvStreamAsync(Model);
            var fileName = $"{Model.TableName}_Export_{DateTime.Now:yyyyMMdd_HHmmss}.csv";

            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Download error: {ex.Message}");
        }
        finally
        {
            showDownloadProgress = false;
            StateHasChanged();
        }
    }

    private void ResetBuilder()
    {
        Model = new QueryBuilderModel { TableName = Model.TableName };
        previewResult = null;
        selectAllColumns = false;
        _ = LoadTableData(); // Reload table data
    }

    private ColumnDefinition GetColumn(string columnName)
    {
        return availableColumns.FirstOrDefault(c => c.Name == columnName);
    }

    private bool IsColumnSelected(string columnName)
    {
        return Model.SelectedColumns.Contains(columnName);
    }

    private List<string> GetEnumOptions(string columnName)
    {
        return enumOptions.ContainsKey(columnName) ? enumOptions[columnName] : new List<string>();
    }

    private async void OnDateValueChanged(ChangeEventArgs e, FilterCondition condition)
    {
        var dateString = e.Value?.ToString();
        if (!string.IsNullOrEmpty(dateString) && DateTime.TryParse(dateString, out DateTime dateValue))
        {
            condition.DateValue = dateValue;
            condition.Value = dateValue.ToString("yyyy-MM-dd");
        }
        else
        {
            condition.DateValue = null;
            condition.Value = "";
        }
        await InvokeAsync(StateHasChanged);
    }

    private async void OnIntValueChanged(ChangeEventArgs e, FilterCondition condition)
    {
        var valueString = e.Value?.ToString();
        if (!string.IsNullOrEmpty(valueString) && int.TryParse(valueString, out int intValue))
        {
            condition.IntValue = intValue;
            condition.Value = intValue.ToString();
        }
        else
        {
            condition.IntValue = null;
            condition.Value = "";
        }
        await InvokeAsync(StateHasChanged);
    }
}
